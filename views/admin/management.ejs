<%- include('../partials/header') %>

<div class="management-container">
  <div class="management-header">
    <div class="header-top">
      <a href="/admin/dashboard" class="btn btn-back">‚Üê Back to Dashboard</a>
    </div>
    <h1>Management System</h1>
    <p class="subtitle">Manage Voters, Candidates, and Admins</p>
  </div>

  <!-- Tabs Navigation -->
  <div class="tabs-nav">
    <button class="tab-btn active" data-tab="voters">üë• Voters</button>
    <button class="tab-btn" data-tab="candidates">üéØ Candidates</button>
    <button class="tab-btn" data-tab="admins">üîê Admins</button>
  </div>

  <!-- ========== VOTERS TAB ========== -->
  <div id="voters" class="tab-content active">
    <div class="section-header">
      <h2>Voter Management</h2>
      <button class="btn btn-primary btn-sm" onclick="toggleForm('voterForm')">+ Add Voter</button>
    </div>

    <!-- Add/Edit Form -->
    <div id="voterForm" class="form-section hidden">
      <form onsubmit="handleVoterSubmit(event)">
        <div class="form-row">
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="voterName" placeholder="Voter name" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="voterEmail" placeholder="voter@example.com" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="voterPassword" placeholder="Password" required>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-success">Save</button>
            <button type="button" class="btn btn-secondary" onclick="toggleForm('voterForm')">Cancel</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="table-wrapper">
      <table class="management-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Voted</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% voters.forEach(voter => { %>
            <tr>
              <td><%= voter.id %></td>
              <td><%= voter.name %></td>
              <td><%= voter.email %></td>
              <td><%= voter.hasVoted ? '‚úì Yes' : '‚úó No' %></td>
              <td><%= new Date(voter.createdAt).toLocaleDateString() %></td>
              <td class="actions">
                <button class="btn btn-sm btn-info" onclick="editVoter(<%= voter.id %>)">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteVoter(<%= voter.id %>)">Delete</button>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ========== CANDIDATES TAB ========== -->
  <div id="candidates" class="tab-content">
    <div class="section-header">
      <h2>Candidate Management</h2>
      <button class="btn btn-primary btn-sm" onclick="toggleForm('candidateForm')">+ Add Candidate</button>
    </div>

    <!-- Add/Edit Form -->
    <div id="candidateForm" class="form-section hidden">
      <form onsubmit="handleCandidateSubmit(event)">
        <div class="form-row">
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="candidateName" placeholder="Candidate name" required>
          </div>
          <div class="form-group">
            <label>Vision</label>
            <textarea id="candidateVision" placeholder="Vision" rows="2"></textarea>
          </div>
          <div class="form-group">
            <label>Mission</label>
            <textarea id="candidateMission" placeholder="Mission" rows="2"></textarea>
          </div>
          <div class="form-group">
            <label>Session</label>
            <select id="candidateSession" required>
              <option value="">Select Session</option>
              <% sessions.forEach(session => { %>
                <option value="<%= session.id %>"><%= session.title %></option>
              <% }); %>
            </select>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-success">Save</button>
            <button type="button" class="btn btn-secondary" onclick="toggleForm('candidateForm')">Cancel</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="table-wrapper">
      <table class="management-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Vision</th>
            <th>Session</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% candidates.forEach(candidate => { %>
            <tr>
              <td><%= candidate.id %></td>
              <td><%= candidate.name %></td>
              <td><%= candidate.vision ? candidate.vision.substring(0, 30) + '...' : '-' %></td>
              <td><%= sessions.find(s => s.id === candidate.electionSessionId)?.title || 'N/A' %></td>
              <td class="actions">
                <button class="btn btn-sm btn-info" onclick="editCandidate(<%= candidate.id %>)">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteCandidate(<%= candidate.id %>)">Delete</button>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ========== ADMINS TAB ========== -->
  <div id="admins" class="tab-content">
    <div class="section-header">
      <h2>Admin Management</h2>
      <button class="btn btn-primary btn-sm" onclick="toggleForm('adminForm')">+ Add Admin</button>
    </div>

    <!-- Add/Edit Form -->
    <div id="adminForm" class="form-section hidden">
      <form onsubmit="handleAdminSubmit(event)">
        <div class="form-row">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="adminUsername" placeholder="Username" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="adminEmail" placeholder="admin@example.com" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="adminPassword" placeholder="Password" required>
          </div>
          <div class="form-group">
            <label>Super Admin</label>
            <select id="adminSuper">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-success">Save</button>
            <button type="button" class="btn btn-secondary" onclick="toggleForm('adminForm')">Cancel</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="table-wrapper">
      <table class="management-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Super Admin</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% admins.forEach(admin => { %>
            <tr>
              <td><%= admin.id %></td>
              <td><%= admin.username %></td>
              <td><%= admin.email %></td>
              <td><%= admin.isSuper ? '‚úì Yes' : '‚úó No' %></td>
              <td><%= new Date(admin.createdAt).toLocaleDateString() %></td>
              <td class="actions">
                <button class="btn btn-sm btn-info" onclick="editAdmin(<%= admin.id %>)">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteAdmin(<%= admin.id %>)">Delete</button>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    this.classList.add('active');
    document.getElementById(this.dataset.tab).classList.add('active');
  });
});

// Toggle form visibility
function toggleForm(formId) {
  const form = document.getElementById(formId);
  form.classList.toggle('hidden');
}

// Handle Voter Submit
async function handleVoterSubmit(event) {
  event.preventDefault();
  const name = document.getElementById('voterName').value;
  const email = document.getElementById('voterEmail').value;
  const password = document.getElementById('voterPassword').value;

  const response = await fetch('/admin/voter/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, email, password })
  });

  if (response.ok) {
    alert('Voter created successfully');
    location.reload();
  } else {
    alert('Failed to create voter');
  }
}

// Handle Candidate Submit
async function handleCandidateSubmit(event) {
  event.preventDefault();
  const name = document.getElementById('candidateName').value;
  const vision = document.getElementById('candidateVision').value;
  const mission = document.getElementById('candidateMission').value;
  const sessionId = document.getElementById('candidateSession').value;

  const response = await fetch('/admin/candidate/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, vision, mission, sessionId })
  });

  if (response.ok) {
    alert('Candidate created successfully');
    location.reload();
  } else {
    alert('Failed to create candidate');
  }
}

// Handle Admin Submit
async function handleAdminSubmit(event) {
  event.preventDefault();
  const username = document.getElementById('adminUsername').value;
  const email = document.getElementById('adminEmail').value;
  const password = document.getElementById('adminPassword').value;
  const isSuper = document.getElementById('adminSuper').value;

  const response = await fetch('/admin/admin/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, email, password, isSuper })
  });

  if (response.ok) {
    alert('Admin created successfully');
    location.reload();
  } else {
    alert('Failed to create admin');
  }
}

// Delete functions
function deleteVoter(id) {
  if (!confirm('Delete this voter?')) return;
  fetch(`/admin/voter/delete/${id}`, { method: 'DELETE' })
    .then(() => { alert('Voter deleted'); location.reload(); })
    .catch(() => alert('Failed to delete'));
}

function deleteCandidate(id) {
  if (!confirm('Delete this candidate?')) return;
  fetch(`/admin/candidate/delete/${id}`, { method: 'DELETE' })
    .then(() => { alert('Candidate deleted'); location.reload(); })
    .catch(() => alert('Failed to delete'));
}

function deleteAdmin(id) {
  if (!confirm('Delete this admin?')) return;
  fetch(`/admin/admin/delete/${id}`, { method: 'DELETE' })
    .then(() => { alert('Admin deleted'); location.reload(); })
    .catch(() => alert('Failed to delete'));
}
</script>

<%- include('../partials/footer') %>
