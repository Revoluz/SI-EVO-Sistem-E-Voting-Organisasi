<%- include('../partials/header') %>

<div class="admin-audit">
  <div class="audit-header">
    <a href="/admin/dashboard" class="btn btn-back">‚Üê Back to Dashboard</a>
    <h1>Audit Logs</h1>
    <p class="subtitle">View system activity and changes</p>
  </div>

  <div class="filter-section">
    <div class="filter-group">
      <label for="filterAction">Filter by Action:</label>
      <select id="filterAction" class="form-control">
        <option value="" <%= !currentAction ? 'selected' : '' %>>All Actions</option>
        <option value="LOGIN" <%= currentAction === 'LOGIN' ? 'selected' : '' %>>Login</option>
        <option value="VOTE" <%= currentAction === 'VOTE' ? 'selected' : '' %>>Vote Submitted</option>
        <option value="START_SESSION" <%= currentAction === 'START_SESSION' ? 'selected' : '' %>>Session Started</option>
        <option value="END_SESSION" <%= currentAction === 'END_SESSION' ? 'selected' : '' %>>Session Ended</option>
        <option value="PAUSE_SESSION" <%= currentAction === 'PAUSE_SESSION' ? 'selected' : '' %>>Pause Session</option>
        <option value="VOTER_CREATED" <%= currentAction === 'VOTER_CREATED' ? 'selected' : '' %>>Voter Created</option>
        <option value="CANDIDATE_ADDED" <%= currentAction === 'CANDIDATE_ADDED' ? 'selected' : '' %>>Candidate Added</option>
        <option value="ADMIN_LOGIN" <%= currentAction === 'ADMIN_LOGIN' ? 'selected' : '' %>>Admin Login</option>  
      </select>
      <br>
      <br>
      <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
    </div>
    <div class="filter-group">
      <label>Date Range:</label>
      <input type="date" id="startDate" class="form-control">
      <input type="date" id="endDate" class="form-control">
      <button class="btn btn-primary" onclick="filterByDate()">Apply Date</button>
    </div>
    <div class="filter-group">
      <label for="limit">Show Last X Logs:</label>
      <input type="number" id="limit" class="form-control" value="<%= limit %>" placeholder="e.g. 50">
      <button class="btn btn-primary" onclick="filterByLimit()">Set Limit</button>
    </div>
  </div>

  <div class="table-section">
    <table class="audit-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Timestamp</th>
          <th>Action</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="auditTableBody">
        <!-- seleksi untuk node head/startNod -->
        <% if (typeof startNode !== 'undefined' && startNode !== null) { %>
          <% 
            // current menyimpan alamat dari head yang dikirimkan dari pagination
            let current = startNode;
            // iterasi berapa banyak datanya
            let i = 0;
            // pagination
            let startIndex = (currentPage - 1) * limit;

            // Iterasi murni menggunakan pointer Linked List
            while (current !== null && i < limit) { 
          %>
            <tr class="audit-row" data-action="<%= current.action %>">
              <td><%= startIndex + i + 1 %></td>
              <td class="timestamp">
                <%= new Date(current.timestamp).toLocaleString() %>
              </td>
              <td>
                <span class="action-badge action-<%= current.action.toLowerCase() %>">
                  <%= current.action %>
                </span>
              </td>
              <td class="details">
                <details>
                  <summary>View Details</summary>
                  <pre><%= current.details %></pre>
                </details>
              </td>
            </tr>
          <% 
              // Berpindah ke node selanjutnya berdasarkan status filter
              current = isFiltered ? current.tempNext : current.next; 
              i++;
            } 
          %>
        <% } else { %>
          <tr>
            <td colspan="4" class="text-center">No audit logs found</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <div class="pagination-footer" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
    <div class="pagination-info">
      Showing page <%= currentPage %> of <%= totalPages %>
    </div>
    <div class="pagination-buttons">
      <% if (currentPage > 1) { %>
        <a href="?page=<%= currentPage - 1 %>&action=<%= currentAction %>" class="btn btn-sm btn-outline-primary">Previous</a>
      <% } %>
      <% if (currentPage < totalPages) { %>
        <a href="?page=<%= currentPage + 1 %>&action=<%= currentAction %>" class="btn btn-sm btn-outline-primary">Next</a>
      <% } %>
    </div>
  </div>

  <div class="audit-stats">
    <h3>Statistics</h3>
    <div class="stats-container">
      <div class="stat">
        <strong>Total Logs (Filtered):</strong> <%= typeof totalCount !== 'undefined' ? totalCount : 0 %>
    </div>
      <div class="stat">
        <strong>Most Recent:</strong>
        <% if (typeof startNode !== 'undefined' && startNode !== null) { %>
          <%= new Date(startNode.timestamp).toLocaleString() %>
        <% } else { %>
          N/A
        <% } %>
      </div>
    </div>
  </div>
</div>

<script>
// fungsi untuk menghapus filter dan return getAll
function clearFilters() {
  window.location.href = '/admin/audit';
}

// fungsi filter beradasarkan Action
function filterAuditLogs() {
  const selectedAction = document.getElementById('filterAction').value;
  // Redirect ke server untuk memproses Linked List sesuai pilihan action
  window.location.href = `/admin/audit?action=${selectedAction}`;
}

// fungsi filter beradasarkan data range
function filterByDate() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    if (start && end) {
        window.location.href = `/admin/audit?start=${start}&end=${end}`;
    } else {
        alert("Please select both start and end dates");
    }
}

// function filter berdasarkan limit data yang ditampilkan
function filterByLimit(){
  const limit = document.getElementById('limit').value;
  if (limit) {
    window.location.href = `/admin/audit?limit=${limit}`;
  } else {
    alert("Please enter a limit value");
  }
}

document.getElementById('filterAction').addEventListener('change', filterAuditLogs);
</script>

<%- include('../partials/footer') %>