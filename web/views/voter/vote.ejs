<%- include('../partials/header') %>

<div class="vote-container">
  <div class="vote-header">
    <h1>Cast Your Vote</h1>
    <p class="session-info">
      <strong>Session:</strong>
      <%= session ? session.title : 'Tidak ada sesi aktif' %>
    </p>
  </div>

  <div class="candidates-grid">
    <% if (candidates && candidates.length > 0) { %>
      <% candidates.forEach(candidate => { %>
        <div class="candidate-card">

          <div class="candidate-photo">
            <% if (candidate.photoUrl) { %>
              <img src="<%= candidate.photoUrl %>" alt="<%= candidate.name %>">
            <% } else { %>
              <div class="photo-placeholder">No Photo</div>
            <% } %>
          </div>

          <div class="candidate-info">
            <h3><%= candidate.name %></h3>

            <% if (candidate.vision) { %>
              <p><strong>Vision:</strong> <%= candidate.vision %></p>
            <% } %>

            <% if (candidate.mission) { %>
              <p><strong>Mission:</strong> <%= candidate.mission %></p>
            <% } %>
          </div>

          <!-- üî• LOGIKA STATUS YANG BENAR -->
          <% if (allowVote) { %>
            <button
              class="btn btn-primary vote-btn"
              data-candidate-id="<%= candidate.id %>"
              data-candidate-name="<%= candidate.name %>"
            >
              Submit Vote
            </button>

          <% } else if (session && session.status === 'PAUSED') { %>
            <p style="color:orange; font-weight:600; margin-top:15px;">
              ‚è∏ Voting sedang dihentikan sementara (PAUSED)
            </p>

          <% } else if (session && session.status === 'ENDED') { %>
            <p style="color:red; font-weight:600; margin-top:15px;">
              ‚õî Voting telah berakhir (ENDED)
            </p>
          <% } %>

        </div>
      <% }); %>
    <% } else { %>
      <div class="alert alert-info">
        No candidates available for this session.
      </div>
    <% } %>
  </div>

  <div class="vote-status">
    <p id="statusMessage"></p>
  </div>
</div>

<script>
document.querySelectorAll('.vote-btn').forEach(btn => {
  btn.addEventListener('click', function () {
    const candidateId = this.dataset.candidateId;
    const candidateName = this.dataset.candidateName;

    if (!candidateId) return;

    if (confirm(`Are you sure you want to vote for ${candidateName}?`)) {
      fetch('/vote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ candidateId: parseInt(candidateId) })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById('statusMessage').textContent =
            '‚úì Vote submitted successfully!';
          setTimeout(() => {
            window.location.href = '/results';
          }, 1000);
        } else {
          document.getElementById('statusMessage').textContent =
            '‚úó ' + (data.message || 'Vote failed');
        }
      })
      .catch(() => {
        document.getElementById('statusMessage').textContent =
          '‚úó Error submitting vote';
      });
    }
  });
});
</script>

<%- include('../partials/footer') %>
